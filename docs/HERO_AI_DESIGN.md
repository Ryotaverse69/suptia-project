# ヒーロー × AI × コスト制御 設計書

> **目的**: Claude（他AI／将来の自分／別エンジニア）が読んで一切迷わない設計原則

---

## 1. 設計の結論（最重要）

ヒーローセクションの入力欄は1つだけ置く。
それは「検索窓」でも「チャット欄」でもなく、
**AIに判断材料を渡すための入力欄**である。

- ユーザーは何を書くかを選ばない
- 解釈・分岐はすべてAI側の責務

---

## 2. ヒーローセクションの役割

### 目的

- 検索させる ❌
- 商品を並べる ❌
- AIとの思考を開始させる ✅

ヒーローは「**AI意思決定エンジンの入口**」。

---

## 3. 入力欄の仕様（UIルール）

### 見た目

- 入力欄：**1つのみ**
- チャットUIにしない
- 検索UIにも見せない

### ユーザー認知

ユーザーが理解すべきことは一つだけ：

> 「ここに書けば、AIが考えてくれる」

### プレースホルダ戦略

プレースホルダは**検索ワードではなく「質問文」**を基本とする。

**良い例：**

- 「妊娠中にビタミンDを飲んでも大丈夫？」
- 「このサプリ、安全性は？」
- 「疲れやすいんだけど、何がいい？」

**悪い例：**

- 「サプリ名・成分名で検索...」（検索UIに見える）
- 「キーワードを入力」（検索UIに見える）

これにより：

- AI相談の認知が一瞬で伝わる
- 無意味な検索入力が減る

---

## 4. 入力してよい内容

この入力欄には以下すべてを許可する：

| 種類   | 例                              |
| ------ | ------------------------------- |
| 成分名 | ビタミンD、オメガ3              |
| 商品名 | ネイチャーメイド マルチビタミン |
| 悩み   | 疲れやすい、眠れない            |
| 条件   | 妊娠中、服薬中                  |
| 疑問   | 安全？多すぎない？              |

**入力の種類はUIで分けない。**

---

## 5. 内部処理フロー

### フェーズ①：AIを呼ばない（デフォルト）

入力直後は**LLMを呼ばない**。

行う処理：

- 正規化（表記ゆれ）
- 辞書マッチ（成分・商品）
- ルール判定（条件・疑問）

**目的**: 入力意図の大まかな分類（ほぼ無料処理）

---

### フェーズ②：軽量AI（必要な場合のみ）

曖昧な入力だけ、短トークンAIを使う。

用途：

- intent分類
- 情報抽出（成分／悩み／条件）

**出力は分類結果のみ。文章生成はしない。**

> **暴走防止ルール（重要）**
> フェーズ②のAI出力は、**事前定義された構造データのみ**とし、自然言語文章の生成は禁止する。
> 「一言返させよう」という誘惑に負けないこと。

---

### フェーズ③：重いAI（価値が出る時だけ）

以下の場合のみ本格的にAIを使う：

- ユーザーが「AIに相談する」を明示
- 条件・背景が揃っている
- 理由説明・注意喚起が必要

ここで初めて：

- 理由付き提案
- エビデンス説明
- 注意点提示

> **コスト防波堤（最重要）**
> フェーズ③（重いAI）は、**ユーザーが明示的に「AIに相談する」意思を示した場合のみ**実行する。
> 暗黙的なトリガーでの起動は禁止。これがコスト事故の最後の防波堤。

---

## 6. 分岐ルール（ユーザーに見せない）

| 入力内容             | 遷移先             |
| -------------------- | ------------------ |
| 明確な成分名・商品名 | 比較／検索ページへ |
| 悩み・条件・疑問     | AI相談フローへ     |

分岐はAIが判断し、UIは常に1つ。

---

## 7. CTAの原則

- 主CTA：**AIに相談する**
- 「検索」という文言は使わない
- 診断・検索ページは補助導線

順序は常に：

```
AI →（必要なら）検索・比較
```

---

## 8. 検索ページの位置づけ

- 検索ページは残す
- ただし主役ではない

役割：**AIが裏取り・検証のために使う画面**

---

## 9. APIコスト制御の原則

| ルール                         | 説明                         |
| ------------------------------ | ---------------------------- |
| 初期入力では重いAIを呼ばない   | 辞書マッチ・ルール判定で分類 |
| intent分類は軽量・短トークン   | Haiku等の軽量モデル使用      |
| AI出力は必ずキャッシュ         | 同一質問は再計算しない       |
| AIは「考えるべき時だけ考える」 | 無駄なAPI呼び出しを避ける    |

### キャッシュ戦略

キャッシュキーは「**正規化済み入力文字列 + intent分類結果**」を基本とする。

```typescript
// キャッシュキーの例
const cacheKey = `${normalizedInput}:${intentType}`;
// → "ビタミンd:ingredient" や "疲れやすい:symptom"
```

これにより：

- 実装者が勝手な単位でキャッシュしない
- ヒット率が安定する
- AI使用量が予測可能になる

---

## 10. 絶対にやらないこと（NG）

- ❌ 検索窓とAI入力欄を並べる
- ❌ 入力欄を2つ置く
- ❌ 「検索 or AI相談」を選ばせる
- ❌ 入力時点で常にLLMを叩く

---

## 11. AIの責任範囲（法務・信頼対策）

> **AIは最終的な判断や断定を行わず、判断材料・理由・注意点を提示する役割に限定する。**

これにより：

- 薬機法・健康領域リスク低減
- 「AIが言ったから」問題を回避
- サイトの信頼性が上がる

---

## 12. UI演出ガイドライン

フェーズ①・②では実際のAI生成が行われなくても、**「情報を整理しています」**というUI表示を行う。

**良い表現：**

- 「情報を整理しています...」
- 「関連する商品を探しています...」

**悪い表現：**

- 「AIが考えています...」（実際にはAIを使っていない場合に誤解を招く）

ポイント：

- APIコスト：ゼロ
- 信頼感：上がる
- ユーザー離脱：減る

---

## 13. 一文まとめ

> サプティアのヒーローは、AIに判断材料を渡すための単一入力欄を持つ。
> 入力の解釈と分岐はAI側が行い、ユーザーに選択を強いない。
> 初期段階ではAI APIを使わず、必要な場面でのみ段階的にAIを起動する。
> **AIは主役だが、常に動く存在ではない。**

---

## 14. 実装ロードマップ

### Phase 1: UI変更（フロントエンド） ✅ 完了

- [x] プレースホルダー変更：質問文形式 + 5秒ローテーション
- [x] ボタン文言変更：「検索」→「AIに聞く」
- [x] コメント・aria-label変更：「Search Box」→「AI Input」

### Phase 2: 分岐ロジック（フロントエンド） ✅ 完了

- [x] 入力内容の簡易判定（正規表現・辞書マッチ）
- [x] 成分名・商品名 → `/search?q=` へ遷移
- [x] 悩み・疑問 → `/concierge?q=` へ遷移

### Phase 3: intent分類API（バックエンド） ✅ 完了

- [x] `/api/intent` エンドポイント作成
- [x] 成分・商品辞書の整備
- [x] キャッシュ機構の実装
- [ ] 軽量AI（Haiku）によるintent分類（低信頼度時のみ・将来実装）

### Phase 4: AIコンシェルジュ側の対応 ✅ 完了

- [x] クエリパラメータ `?q=` の受け取り
- [x] 自動的にAI応答を開始（ヒーローから来た場合 = 明示的意思表示）

---

## 15. 関連ファイル

| ファイル                                             | 役割                                                           |
| ---------------------------------------------------- | -------------------------------------------------------------- |
| `apps/web/src/components/landing/HeroRevolution.tsx` | ヒーローセクションUI・intent判定                               |
| `apps/web/src/components/concierge/ChatUI.tsx`       | チャットUI・クエリパラメータ受取・自動送信                     |
| `apps/web/src/app/concierge/page.tsx`                | AIコンシェルジュページ                                         |
| `apps/web/src/app/api/concierge/chat/route.ts`       | AI APIエンドポイント                                           |
| `apps/web/src/lib/concierge/types.ts`                | 型定義・プラン設定                                             |
| `apps/web/src/app/api/intent/route.ts`               | Intent分類APIエンドポイント                                    |
| `apps/web/src/lib/intent/`                           | Intent分類ライブラリ（types, classifier, dictionaries, cache） |

---

## 16. 更新履歴

| 日付       | 内容                                                                       |
| ---------- | -------------------------------------------------------------------------- |
| 2026-01-01 | 初版作成（Phase A完了後の次ステップとして）                                |
| 2026-01-01 | v1.1: 暴走防止・責任範囲・キャッシュ戦略・UI演出・プレースホルダ戦略を追加 |
| 2026-01-02 | v1.2: Phase 1, 2, 4 実装完了                                               |
| 2026-01-03 | v1.3: Phase 3 実装完了（/api/intent、辞書、キャッシュ）                    |

---

**この設計なら：**

- Claudeも迷わない
- 実装者も迷わない
- コストも破綻しない
- 思想もブレない

**「AI主役なのに、賢くケチなプロダクト」** を実現する。
