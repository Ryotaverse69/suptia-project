# 全成分表示機能 - テストガイド

## 📋 実装概要

全成分表示機能が実装され、商品詳細ページの「エビデンスと安全性」セクションに追加されました。

### 実装されたファイル

1. **スキーマ拡張**
   - `packages/schemas/product.ts` - `allIngredients`フィールドを追加

2. **コンポーネント拡張**
   - `apps/web/src/components/EvidenceSafetyDetail.tsx` - 全成分表示セクションを追加

3. **ページ更新**
   - `apps/web/src/app/products/[slug]/page.tsx` - 全成分データを取得してコンポーネントに渡す

4. **テストスクリプト**
   - `scripts/add-all-ingredients-sample.mjs` - サンプル商品に全成分データを追加
   - `scripts/create-test-product-with-additives.mjs` - 添加物検出テスト用商品を作成

## 🎯 主要機能

### 1. 全成分リスト表示

- 商品に含まれる全成分を見やすく表示
- 栄養成分表示も含めて完全な情報を提供

### 2. 懸念される添加物の自動検出

30種類の添加物を自動検出：

- **保存料**: 安息香酸、パラベン、ソルビン酸など
- **人工甘味料**: アスパルテーム、スクラロース、サッカリンなど
- **着色料（タール系）**: 赤色2号、赤色40号、黄色4号など
- **酸化防止剤**: BHA、BHT
- **その他**: 亜硝酸ナトリウム、カラギーナン、二酸化チタンなど

### 3. 重要度別の色分け表示

- 🔴 **Critical（要注意）**: 赤色表示（-6～-8点）
  - BHA、BHT、亜硝酸ナトリウムなど
- 🟠 **Warning（警告）**: オレンジ色表示（-4～-6点）
  - パラベン、人工甘味料、タール系着色料など
- 🟡 **Info（情報）**: 黄色表示（-2～-3点）
  - ソルビン酸、スクラロース、ステアリン酸マグネシウムなど

### 4. 安全性スコアへの影響表示

- 各添加物のペナルティポイントを明示
- 安全性スコアへの影響を可視化

### 5. 安全マーク

- 懸念される添加物が検出されない場合は緑色のチェックマークを表示

## 🧪 テスト手順

### ステップ1: サンプルデータの確認

以下の商品に全成分データが追加されています：

1. **DHC ビタミンC**

   ```
   http://localhost:3001/products/dhc-dhc-c-60-120
   ```

   - 懸念される添加物なし
   - 緑色の安全マークが表示されるはず

2. **mitete 葉酸サプリ**

   ```
   http://localhost:3001/products/mitete-30-afc
   ```

   - 複数の成分を含む
   - 懸念される添加物なし

3. **DHA&EPA+ビタミンD**
   ```
   http://localhost:3001/products/dha-epa-d-120-57-2g-1-477mg-120-30-3
   ```

   - オメガ3脂肪酸配合
   - 懸念される添加物なし

### ステップ2: 添加物検出機能のテスト

**テスト用商品**（懸念される添加物を多数含む）

```
http://localhost:3001/products/test-product-with-additives
```

#### 確認ポイント:

✅ **全成分表示セクションが表示される**

- 「全成分表示」の見出し（薬のアイコン付き）

✅ **オレンジ色の警告ボックスが表示される**

- 「懸念される添加物が検出されました」というメッセージ

✅ **検出された添加物がリスト表示される**

- アスパルテーム（オレンジ色）
- 安息香酸ナトリウム（オレンジ色）
- 赤色40号、赤色2号、黄色4号（オレンジ色）
- BHA、BHT（赤色、「要注意」マーク付き）
- 亜硝酸ナトリウム（赤色、「要注意」マーク付き）
- その他

✅ **各添加物にペナルティポイントが表示される**

- 例: "BHA (-7点)"

✅ **安全性スコアへの影響が反映される**

- 安全性スコアが大幅に減点されているはず（複数の添加物によるペナルティ合計）

### ステップ3: UI/UXの確認

✅ **レイアウト**

- 全成分表示セクションが「エビデンスと安全性」内に配置
- 注意事項の後、安全性の詳細説明の前に表示

✅ **デザイン**

- 青色の背景（bg-blue-50）でセクション全体を囲む
- 警告ボックスはオレンジ色（bg-orange-50、border-orange-400）
- 全成分テキストは白色の背景ボックス内

✅ **レスポンシブ**

- モバイル、タブレット、デスクトップで正常に表示
- テキストが適切に改行される（whitespace-pre-wrap）

## 📊 添加物ペナルティ一覧

| 添加物名                                     | ペナルティ | 重要度   |
| -------------------------------------------- | ---------- | -------- |
| 亜硝酸ナトリウム                             | -8点       | Critical |
| BHA（ブチルヒドロキシアニソール）            | -7点       | Critical |
| BHT（ジブチルヒドロキシトルエン）            | -7点       | Critical |
| 赤色2号、赤色3号、赤色40号、赤色102号～106号 | -6点       | Warning  |
| 黄色4号、黄色5号                             | -6点       | Warning  |
| 青色1号、青色2号                             | -6点       | Warning  |
| 安息香酸、安息香酸ナトリウム                 | -5点       | Warning  |
| パラベン、パラオキシ安息香酸                 | -5点       | Warning  |
| サッカリン、サッカリンナトリウム             | -5点       | Warning  |
| 二酸化チタン                                 | -5点       | Warning  |
| アスパルテーム                               | -4点       | Warning  |
| アセスルファムK                              | -4点       | Warning  |
| カラギーナン                                 | -4点       | Warning  |
| スクラロース                                 | -3点       | Info     |
| ソルビン酸、ソルビン酸カリウム               | -3点       | Info     |
| リン酸塩                                     | -3点       | Info     |
| ステアリン酸マグネシウム                     | -2点       | Info     |

**重要**: ペナルティは累積され、上限なしで適用されます。

## 🔧 Sanityでの全成分データの追加方法

### 方法1: Sanity Studioで手動追加

1. Sanity Studio（http://localhost:3333）を開く
2. 商品（Product）を選択
3. 「全成分表示」フィールドに全成分リストを入力
4. 保存

### 方法2: スクリプトで一括追加

```bash
# サンプルデータを追加
node scripts/add-all-ingredients-sample.mjs

# テスト商品を作成
node scripts/create-test-product-with-additives.mjs
```

### 全成分データの記述例

```
ビタミンC、セルロース、ステアリン酸カルシウム、微粒二酸化ケイ素

【栄養成分表示（2粒あたり）】
エネルギー：3.86kcal
たんぱく質：0.01g
脂質：0.04g
炭水化物：0.87g
食塩相当量：0.001g
ビタミンC：1,000mg
```

## 🎨 カスタマイズ方法

### 添加物リストの追加・変更

`apps/web/src/lib/auto-scoring.ts`の`UNSAFE_ADDITIVES`配列を編集：

```typescript
const UNSAFE_ADDITIVES = [
  // 新しい添加物を追加
  { name: "新添加物名", penalty: -5, severity: "warning" },
  // ...
];
```

### 色・デザインの変更

`apps/web/src/components/EvidenceSafetyDetail.tsx`のスタイルクラスを編集：

```typescript
// 警告ボックスの色
className = "bg-orange-50 border-orange-400";

// 重要度別の色
const severityColors = {
  critical: "bg-red-100 text-red-800 border-red-300",
  warning: "bg-orange-100 text-orange-800 border-orange-300",
  info: "bg-yellow-100 text-yellow-800 border-yellow-300",
};
```

## ✅ チェックリスト

実装完了後、以下を確認してください：

- [ ] 型チェックが通る（`npx tsc --noEmit`）
- [ ] リントが通る（`npx eslint src/components/EvidenceSafetyDetail.tsx`）
- [ ] 開発サーバーがエラーなく起動する
- [ ] 通常の商品で全成分表示が正しく表示される
- [ ] 添加物を含む商品で警告が表示される
- [ ] 添加物を含まない商品で安全マークが表示される
- [ ] モバイルで正常に表示される
- [ ] 全成分データがない商品でもエラーが出ない（セクション非表示）

## 🚀 今後の拡張

以下の機能追加を検討できます：

1. **添加物の詳細情報**
   - 各添加物をクリックすると詳細説明を表示
   - 参考文献へのリンク

2. **ユーザー設定**
   - 避けたい添加物をユーザーが指定
   - カスタム警告の表示

3. **アレルギー警告**
   - アレルゲンの自動検出
   - 特定原材料7品目、準特定原材料21品目

4. **添加物スコア**
   - 添加物の安全性レベルを視覚化
   - 他の商品との比較

5. **トレンド表示**
   - 添加物を含まない商品の増加傾向
   - 業界平均との比較

---

**最終更新**: 2025-10-29
**バージョン**: 1.0.0
**ステータス**: ✅ 実装完了・テスト可能
