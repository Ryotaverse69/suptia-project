# 商品ランク検証システム

Suptiaの商品ランク整合性を自動的にチェックし、問題を検出するシステムです。

## 📋 目次

- [概要](#概要)
- [検証内容](#検証内容)
- [使い方](#使い方)
- [CI/CD統合](#cicd統合)
- [トラブルシューティング](#トラブルシューティング)

---

## 概要

このシステムは、以下の3つのコンポーネントで構成されています：

### 1. **Sanityデータ検証スクリプト**

`scripts/validate-all-products-ranks.mjs`

- 全商品（329件）のSanityデータベースを検証
- tierRatingsの存在・妥当性をチェック
- 必須データ（価格、成分、容量）の確認

### 2. **ランク整合性テスト**

`apps/web/src/lib/__tests__/product-rank-consistency.test.ts`

- Sanityデータとフロントエンド表示の整合性を検証
- パーセンタイルベースのランク計算が正しいか確認
- バッジシステムによる不正な格上げがないか監視

### 3. **GitHub Actions自動実行**

`.github/workflows/product-rank-validation.yml`

- 毎日深夜2時（JST）に自動実行
- PRまたはpush時にも実行
- 毎週日曜日に全商品のランク再計算

---

## 検証内容

### ✅ Sanityデータ検証

| 項目                     | 内容                                                     |
| ------------------------ | -------------------------------------------------------- |
| **tierRatingsの存在**    | 全商品にtierRatingsフィールドがあるか                    |
| **ランクの妥当性**       | S+/S/A/B/C/Dの範囲内か                                   |
| **必須データ**           | 価格、成分、容量データが正しく設定されているか           |
| **パーセンタイル基準**   | Sランクが全体の約10%以下か（パーセンタイルベース検証）   |
| **5冠達成の整合性**      | overallRank=S+の商品がすべてSランクを持っているか        |
| **論理的整合性**         | コスパSの商品が価格S/A/Bのいずれかであるか               |
| **DHC商品の修正確認**    | 複数成分バグ修正後、コスパS・含有量Dが正しく設定されるか |
| **成分データ有無の確認** | 成分データがない商品が低ランクになっているか             |

### ✅ フロントエンド表示検証

| 項目                         | 内容                                                     |
| ---------------------------- | -------------------------------------------------------- |
| **バッジ格上げの無効化**     | バッジシステムがランクを不正に格上げしていないか         |
| **パーセンタイルベース尊重** | Sanityのパーセンタイルベースランクがそのまま表示されるか |
| **統計情報の妥当性**         | Sランクが全体の10%前後であるか                           |
| **キャッシュ整合性**         | 古いキャッシュで不正確なランクが表示されていないか       |

---

## 使い方

### 🔍 **全商品のランク検証**

```bash
# 全商品を検証（問題のある商品のみ表示）
npm run validate:ranks:all

# 詳細ログ付き（全商品の状態を表示）
npm run validate:ranks:verbose
```

**出力例**：

```
🔍 全商品のランク整合性チェックを開始...

📊 対象商品数: 329件

✅ 問題なし: 322件
❌ 問題あり: 7件
  - tierRatings未設定: 0件
  - 無効なランク: 0件
  - データ不足: 7件

📄 詳細レポートを出力しました: /tmp/product-validation-report.json
```

---

### 🧪 **ランク整合性テスト実行**

```bash
# ランク整合性テストのみ実行
npm run test:rank-consistency

# 全テストを実行
npm test
```

**テスト項目**：

- ✅ 全てのサンプル商品にtierRatingsが存在する
- ✅ 全てのランクが有効な値（S+/S/A/B/C/D）である
- ✅ パーセンタイルベースのランク計算が正しい（S+はすべてSランク）
- ✅ 成分データがある商品のみランク付けされている
- ✅ DHC ビタミンC商品のランクが修正されている（コスパS、含有量D）
- ✅ 価格ランクとコスパランクの論理的整合性
- ✅ バッジによるランク格上げが無効化されている
- ✅ 全商品の90%以上がtierRatingsを持っている
- ✅ Sランクの商品が全体の10%以下である（パーセンタイル基準）

---

### 🔧 **完全なランクチェック**

```bash
# 検証 → テスト の順で実行
npm run ranks:full-check
```

このコマンドは以下を順番に実行します：

1. `validate:ranks:all`：Sanityデータベースの全商品を検証
2. `test:rank-consistency`：ランク整合性テストを実行

---

### 🛠️ **ランクの再計算と修正**

```bash
# 全商品のランクを再計算
npm run calculate:tier-ranks:fix

# 再計算後に検証
npm run ranks:full-check
```

---

## CI/CD統合

### GitHub Actionsワークフロー

#### 1. **自動検証（毎日）**

- **実行タイミング**：毎日深夜2時（JST）
- **内容**：
  - Sanityデータベースの全商品を検証
  - ランク整合性テストを実行
  - 失敗時はSlack通知

#### 2. **PRまたはpush時の検証**

- **実行タイミング**：以下のファイルが変更された場合
  - `apps/web/src/app/products/**`
  - `scripts/auto-calculate-tier-ranks.mjs`
  - `apps/web/src/lib/badges*.ts`
- **内容**：
  - ランク計算ロジックの変更が問題を引き起こしていないか確認

#### 3. **自動ランク再計算（毎週）**

- **実行タイミング**：毎週日曜日の深夜3時（JST）
- **内容**：
  - 全商品のランクを最新データに基づいて再計算
  - 成功時はSlack通知

---

## トラブルシューティング

### ❌ 問題: tierRatings未設定

**原因**：

- 新しい商品がSanityに追加されたが、ランク計算されていない

**解決策**：

```bash
npm run calculate:tier-ranks:fix
```

---

### ❌ 問題: 無効なランク値

**原因**：

- tierRatingsに不正な値（例: "SS"、"F"）が設定されている

**解決策**：

```bash
# 自動修正
npm run validate:ranks:fix

# または手動でSanityを確認
```

---

### ❌ 問題: データ不足

**原因**：

- 価格、成分、容量データが欠落または無効

**解決策**：

1. Sanityスタジオでデータを確認
2. 必須データを入力
3. 再度ランク計算

```bash
npm run calculate:tier-ranks:fix
```

---

### ❌ 問題: フロントエンドで古いランクが表示される

**原因**：

- Vercel/Next.jsのキャッシュが古いデータを返している

**解決策**：

1. **時間経過で自動解決**（数時間以内に自動更新）
2. **手動でキャッシュクリア**：Vercelダッシュボードから「Redeploy」
3. **強制的にページ再生成**：商品データをSanityで再度更新

---

## 今後の改善予定

- [ ] E2Eテストの追加（Playwright）でフロントエンド表示を自動確認
- [ ] 検証失敗時の自動修正機能
- [ ] ランク変動の履歴トラッキング
- [ ] パーセンタイル計算アルゴリズムの可視化ダッシュボード

---

## 関連ファイル

| ファイル                                                      | 説明                       |
| ------------------------------------------------------------- | -------------------------- |
| `scripts/validate-all-products-ranks.mjs`                     | Sanityデータ検証スクリプト |
| `apps/web/src/lib/__tests__/product-rank-consistency.test.ts` | ランク整合性テスト         |
| `.github/workflows/product-rank-validation.yml`               | GitHub Actions自動実行     |
| `scripts/auto-calculate-tier-ranks.mjs`                       | ランク計算エンジン         |
| `apps/web/src/app/products/[slug]/page.tsx`                   | 商品詳細ページ             |
| `/tmp/product-validation-report.json`                         | 検証レポート（失敗時）     |

---

**最終更新日**: 2025-11-11
**バージョン**: 1.0.0
