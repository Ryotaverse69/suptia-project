# 楽天API取得ガイド

## 📋 必要なもの

- 楽天会員アカウント（楽天市場でお買い物できるアカウント）
- Webサイト/アプリの情報（Suptiaの情報）
- 10-15分の時間

---

## ステップ1: 楽天アフィリエイトへの登録

### 1-1. 楽天アフィリエイトにアクセス

🔗 https://affiliate.rakuten.co.jp/

### 1-2. 「アフィリエイトをはじめる」ボタンをクリック

- 楽天会員IDでログイン
- まだ会員でない場合は新規登録

### 1-3. アフィリエイト登録フォームを入力

**必要情報**:

| 項目           | 入力内容                                                |
| -------------- | ------------------------------------------------------- |
| サイト名       | `Suptia（サプティア）`                                  |
| サイトURL      | `https://suptia.com`（開発中は`http://localhost:3000`） |
| サイトジャンル | `健康・美容`                                            |
| サイト概要     | `サプリメント比較・意思決定プラットフォーム`            |
| 月間PV         | `開発中（予定: 10,000PV/月）`                           |
| 運営者情報     | あなたの氏名・住所                                      |
| 報酬受取口座   | 楽天銀行または他銀行口座                                |

### 1-4. 規約に同意して登録完了

✅ これで楽天アフィリエイトIDが発行されます

**アフィリエイトID確認方法**:

1. 楽天アフィリエイトにログイン
2. 右上のアカウント情報から確認
3. 形式: `1234567890.abcdefgh`

---

## ステップ2: 楽天Webサービスへの登録

### 2-1. 楽天Webサービスにアクセス

🔗 https://webservice.rakuten.co.jp/

### 2-2. 「新規アプリ登録（無料）」をクリック

- 楽天会員IDでログイン（同じアカウント）

### 2-3. アプリケーション情報を入力

**新規アプリ登録フォーム**:

| 項目          | 入力内容                                                                                                                                                 |
| ------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アプリ名      | `Suptia`                                                                                                                                                 |
| アプリURL     | `https://suptia.com`                                                                                                                                     |
| アプリの説明  | `科学的エビデンスに基づくサプリメント比較・意思決定プラットフォーム。楽天市場の商品価格をリアルタイムで取得し、成分量を正規化した価格比較を提供します。` |
| 会社名/組織名 | 個人の場合は `個人` または あなたの名前                                                                                                                  |
| 郵便番号      | あなたの郵便番号                                                                                                                                         |
| 住所          | あなたの住所                                                                                                                                             |
| 電話番号      | あなたの電話番号                                                                                                                                         |

### 2-4. 利用規約に同意して登録

✅ アプリケーションIDが即座に発行されます！

**アプリケーションID確認方法**:

1. 楽天Webサービスの管理画面
2. 「アプリID発行・確認」
3. 形式: `1234567890123456789`（19桁の数字）

### 2-5. アフィリエイトIDを紐付け（重要！）

1. アプリ管理画面で「アフィリエイトID設定」を開く
2. ステップ1で取得したアフィリエイトIDを入力
3. 保存

✅ これで収益化の準備完了！

---

## ステップ3: .env.localへの設定

### 3-1. 環境変数ファイルを作成

```bash
# プロジェクトルートで実行
cd /Users/ryota/VScode/suptia-project
cp apps/web/.env.local.example apps/web/.env.local
```

### 3-2. .env.localを編集

```bash
# エディタで開く
code apps/web/.env.local
# または
vim apps/web/.env.local
```

### 3-3. 楽天API情報を入力

以下の部分を編集：

```bash
# ----------------------------------------------------------------------------
# 楽天市場API（優先 - MVP期間中のメインデータソース）
# ----------------------------------------------------------------------------
RAKUTEN_APPLICATION_ID=1234567890123456789  # ← ここに取得したアプリケーションID
RAKUTEN_AFFILIATE_ID=1234567890.abcdefgh    # ← ここに取得したアフィリエイトID
```

**入力例**:

```bash
RAKUTEN_APPLICATION_ID=1234567890123456789
RAKUTEN_AFFILIATE_ID=1234567890.abcdefgh
```

### 3-4. 保存して閉じる

---

## ステップ4: 動作確認

### 4-1. 開発サーバーを起動

```bash
npm run dev
```

サーバーが起動したら http://localhost:3000 にアクセス

### 4-2. API疎通テスト

#### テスト1: 楽天API直接テスト

```bash
# 別のターミナルで実行
curl "https://app.rakuten.co.jp/services/api/IchibaItem/Search/20220601?format=json&keyword=ビタミンC&applicationId=YOUR_APPLICATION_ID&hits=1"
```

**成功レスポンス例**:

```json
{
  "Items": [
    {
      "Item": {
        "itemName": "ビタミンC 1000mg...",
        "itemPrice": 1980,
        "itemUrl": "https://item.rakuten.co.jp/..."
      }
    }
  ]
}
```

**エラーレスポンス例**:

```json
{
  "error": "wrong_parameter",
  "error_description": "specify valid applicationId"
}
```

→ エラーの場合はアプリケーションIDを再確認

#### テスト2: Suptia価格同期APIテスト

```bash
# JAN/ASINなしのキーワード検索テスト
curl -X POST http://localhost:3000/api/sync/prices \
  -H "Content-Type: application/json" \
  -d '{
    "identifier": {
      "title": "ビタミンC 1000mg"
    }
  }'
```

**成功レスポンス例**:

```json
{
  "success": true,
  "results": [
    {
      "source": "rakuten",
      "success": true,
      "price": 1880,
      "currency": "JPY",
      "url": "https://item.rakuten.co.jp/..."
    }
  ],
  "timestamp": "2025-10-20T12:00:00Z"
}
```

**エラーレスポンス例**:

```json
{
  "error": "No API credentials configured",
  "hint": "Set AMAZON_ACCESS_KEY_ID and/or RAKUTEN_APPLICATION_ID in .env.local"
}
```

→ エラーの場合は`.env.local`の内容を再確認

#### テスト3: ヘルスチェック

```bash
# 楽天APIの疎通確認
curl http://localhost:3000/api/health/rakuten
```

（このエンドポイントは今後実装予定）

---

## ステップ5: トラブルシューティング

### Q1: 「wrong_parameter」エラーが出る

**原因**: アプリケーションIDが正しくない

**解決方法**:

1. 楽天Webサービスの管理画面でアプリケーションIDを再確認
2. `.env.local`にコピペミスがないか確認
3. 前後にスペースが入っていないか確認
4. 開発サーバーを再起動（`Ctrl+C` → `npm run dev`）

### Q2: 「No API credentials configured」エラー

**原因**: 環境変数が読み込まれていない

**解決方法**:

1. `.env.local`がapps/webディレクトリにあるか確認

```bash
ls -la apps/web/.env.local
```

2. ファイル名が正しいか確認（`.env.local.example`ではなく`.env.local`）

3. 開発サーバーを再起動

### Q3: アフィリエイトIDがわからない

**解決方法**:

1. https://affiliate.rakuten.co.jp/ にログイン
2. 右上のアカウント情報
3. 「アフィリエイトID」を確認

### Q4: 楽天アフィリエイト登録で「審査中」と表示される

**解決方法**:

- 楽天アフィリエイトは即時承認が多いですが、場合によっては審査に1-2営業日かかります
- 審査中でも楽天Webサービスは利用可能（アフィリエイトリンクは生成されない）
- 審査通過後にアフィリエイトIDを設定すればOK

### Q5: 価格が0円で返ってくる

**原因**: 商品が見つからない、またはキーワードが不適切

**解決方法**:

- より具体的なキーワードを使う
- JAN/ASINを使った検索を試す
- 楽天市場で実際に検索して商品が存在するか確認

---

## 📊 利用制限と料金

### 無料プラン

| 項目                  | 制限                 |
| --------------------- | -------------------- |
| 月間リクエスト数      | **10,000リクエスト** |
| 1秒あたりのリクエスト | 1リクエスト          |
| 料金                  | **無料**             |

### 計算例（MVP期間）

```
1日1回の深夜バッチ同期
商品数: 100商品
月間リクエスト: 100商品 × 30日 = 3,000リクエスト

→ 無料枠（10,000）で十分！
```

### 有料プラン（将来的に必要な場合）

| プラン       | 月額料金 | 月間リクエスト数  |
| ------------ | -------- | ----------------- |
| スタンダード | ¥5,000   | 100,000リクエスト |
| プロ         | ¥10,000  | 200,000リクエスト |

→ 月間PV 10万以上になったら検討

---

## ✅ セットアップ完了チェックリスト

- [ ] 楽天アフィリエイトに登録完了
- [ ] アフィリエイトIDを取得（形式: `1234567890.abcdefgh`）
- [ ] 楽天Webサービスに登録完了
- [ ] アプリケーションIDを取得（形式: `1234567890123456789`）
- [ ] アフィリエイトIDをアプリに紐付け
- [ ] `.env.local`にIDを設定
- [ ] 開発サーバーで動作確認成功
- [ ] API疎通テスト成功

全てチェックが付いたら、楽天API連携完了です！🎉

---

## 🚀 次のステップ

### 1. Sanity商品データに楽天itemCodeを追加

商品を登録する際に楽天の商品コードを紐付けます。

**例**: ビタミンC商品

- JAN: `4573117580016`
- 楽天itemCode: `vitamin-store:12345678`（楽天URLから取得）
- タイトル: `ビタミンC 1000mg 60粒`

### 2. 価格同期の自動化（Vercel Cron Job）

深夜3時に全商品の価格を自動更新。

**設定方法**: 別途ガイドを参照（`docs/VERCEL_CRON_SETUP.md`）

### 3. 商品ページに楽天価格を表示

フロントエンドで価格データを取得して表示。

---

## 📞 サポート

### 公式ドキュメント

- 楽天アフィリエイトヘルプ: https://affiliate.rakuten.co.jp/help/
- 楽天Webサービスドキュメント: https://webservice.rakuten.co.jp/documentation/
- 楽天商品検索API: https://webservice.rakuten.co.jp/documentation/ichiba-item-search

### よくある質問

- 楽天WebサービスFAQ: https://webservice.rakuten.co.jp/support/faq/

---

**最終更新**: 2025-10-20
**バージョン**: 1.0.0
