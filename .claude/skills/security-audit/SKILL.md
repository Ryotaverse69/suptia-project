---
name: security-audit
description: Webアプリケーションの脆弱性・セキュリティ診断を実行。コードベースの静的解析、依存関係の脆弱性、シークレット漏洩、セキュリティヘッダー、認証・認可ロジックを包括的にチェック。「セキュリティチェック」「脆弱性チェック」「脆弱性診断」「セキュリティ診断」「セキュリティ監査」などの要求時に使用。コード修正は行わず、報告と修正案のみを提示。(project)
---

# Security Audit Skill

## 重要な原則

- **コード修正は絶対に行わない** - 報告と修正案の提示のみ
- ターミナルへ直接出力（Markdownファイル生成しない）
- 重要度分類: Critical > High > Medium > Low > Info

## 実行ワークフロー

### Step 1: 依存関係の脆弱性チェック

```bash
npm audit --json 2>/dev/null || echo "npm audit failed"
```

既知の脆弱性を持つパッケージを特定。

### Step 2: シークレット・機密情報の漏洩チェック

以下のパターンをGrep検索:

- APIキー: `(api[_-]?key|apikey)\s*[:=]\s*["']?[a-zA-Z0-9_-]{20,}`
- シークレット: `(secret|password|token)\s*[:=]\s*["'][^"']+["']`
- ハードコードされた認証情報
- .envファイルのコミット状況

除外対象: `node_modules/`, `.env.example`, `.env.local.example`

### Step 3: コードベース静的解析

詳細は [references/checklist.md](references/checklist.md) 参照。

主要チェック項目:

- **XSS**: `dangerouslySetInnerHTML`, 未サニタイズ出力
- **SQLインジェクション**: 文字列結合によるクエリ構築
- **コマンドインジェクション**: `exec()`, `spawn()` への未検証入力
- **認証・認可**: 保護されていないAPIルート、セッション管理

### Step 4: セキュリティヘッダー・設定チェック

- `next.config.js` のheaders設定
- CSP (Content-Security-Policy)
- CORS設定
- HTTPOnly/Secure Cookie設定

### Step 5: 認証・認可ロジックのレビュー

- Supabase RLS (Row Level Security) 設定
- ミドルウェアによるルート保護
- APIエンドポイントの認証チェック

## 出力フォーマット

```
═══════════════════════════════════════════════════════════════
🔒 セキュリティ診断レポート
═══════════════════════════════════════════════════════════════

📊 サマリー
───────────────────────────────────────────────────────────────
Critical: X件 | High: X件 | Medium: X件 | Low: X件 | Info: X件

🚨 Critical (即時対応必須)
───────────────────────────────────────────────────────────────
[ID] 脆弱性タイトル
     ファイル: path/to/file.ts:行番号
     説明: 問題の詳細
     修正案: 具体的な修正方法

⚠️ High (早急に対応)
───────────────────────────────────────────────────────────────
...

⚡ Medium (計画的に対応)
───────────────────────────────────────────────────────────────
...

📝 Low (余裕があれば対応)
───────────────────────────────────────────────────────────────
...

ℹ️ Info (参考情報)
───────────────────────────────────────────────────────────────
...

═══════════════════════════════════════════════════════════════
✅ 診断完了 | 検査ファイル数: X | 検出数: X
═══════════════════════════════════════════════════════════════
```

## 重要度の判定基準

| 重要度   | 基準                                                   |
| -------- | ------------------------------------------------------ |
| Critical | 即座に悪用可能、データ漏洩・システム侵害の直接的リスク |
| High     | 悪用可能だが条件付き、重大な影響の可能性               |
| Medium   | 悪用には複数条件が必要、限定的な影響                   |
| Low      | 理論上のリスク、ベストプラクティス違反                 |
| Info     | 改善推奨事項、セキュリティ強化の提案                   |

## リソース

- [references/checklist.md](references/checklist.md) - 詳細なチェックリストとパターン
