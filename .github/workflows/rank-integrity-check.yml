name: Rank Integrity Check

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      autoFix:
        description: 'è‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œ'
        required: false
        type: boolean
        default: false
  push:
    paths:
      - 'scripts/auto-calculate-tier-ranks.mjs'
      - 'scripts/quick-validate.mjs'
      - 'scripts/fix-all-rank-issues.mjs'
      - 'apps/web/src/lib/tier-ranking.ts'
      - 'apps/web/src/lib/badges*.ts'
      - '.github/workflows/rank-integrity-check.yml'

jobs:
  check-integrity:
    name: Check Rank Integrity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run rank integrity validation
        id: validate
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          # ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹å¯¾å¿œã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          node scripts/quick-validate.mjs || echo "VALIDATION_FAILED=true" >> $GITHUB_ENV

          # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
          echo "## ğŸ” ãƒ©ãƒ³ã‚¯æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node scripts/quick-validate.mjs 2>&1 | tee validation-result.txt >> $GITHUB_STEP_SUMMARY || true

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rank-integrity-report-${{ github.run_number }}
          path: reports/rank-integrity-*.html
          retention-days: 30

      - name: Calculate tier ranks if needed
        if: env.VALIDATION_FAILED == 'true'
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "âš ï¸ Validation failed. Running tier rank calculation..."
          npm run calculate:tier-ranks

      - name: Auto-fix issues if requested
        if: github.event.inputs.autoFix == 'true'
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "ğŸ”§ Running comprehensive auto-fix..."
          echo "## ğŸ”§ è‡ªå‹•ä¿®æ­£ãƒ—ãƒ­ã‚»ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm run ranks:fix-all 2>&1 | tee auto-fix-result.txt
          echo "" >> $GITHUB_STEP_SUMMARY
          cat auto-fix-result.txt >> $GITHUB_STEP_SUMMARY

      - name: Final validation
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "ğŸ” Running final validation..."
          npm run validate:ranks --quiet || echo "STILL_HAS_ISSUES=true" >> $GITHUB_ENV

      - name: Create issue if problems persist
        if: env.STILL_HAS_ISSUES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âš ï¸ ãƒ©ãƒ³ã‚¯æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼æ¤œå‡º - ${new Date().toLocaleDateString('ja-JP')}`;
            const body = `
            ## ğŸ” ãƒ©ãƒ³ã‚¯æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ### æ¤œå‡ºæ—¥æ™‚
            ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}

            ### çŠ¶æ³
            - è‡ªå‹•æ¤œè¨¼ã§æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
            - è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸãŒã€å®Œå…¨ã«ã¯è§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸ

            ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            1. [æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèª
            2. æ‰‹å‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªãƒ»ä¿®æ­£
            3. \`npm run ranks:full-check\` ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ

            ### é–¢é€£ãƒªãƒ³ã‚¯
            - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)

            ---
            *ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
            `;

            // åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã®IssueãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'rank-integrity'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('ãƒ©ãƒ³ã‚¯æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼æ¤œå‡º')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['rank-integrity', 'automated', 'bug']
              });
            }

      - name: Notify Slack if configured
        if: env.STILL_HAS_ISSUES == 'true' && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âš ï¸ Suptia: ãƒ©ãƒ³ã‚¯æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
              "attachments": [{
                "color": "warning",
                "fields": [
                  {
                    "title": "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼",
                    "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ã‚’è¦‹ã‚‹>",
                    "short": true
                  },
                  {
                    "title": "å®Ÿè¡Œæ—¥æ™‚",
                    "value": "'$(date '+%Y-%m-%d %H:%M:%S JST')'",
                    "short": true
                  }
                ]
              }]
            }'

  # æˆåŠŸæ™‚ã®çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
  generate-statistics:
    name: Generate Statistics
    runs-on: ubuntu-latest
    needs: check-integrity
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate statistics summary
        run: |
          echo "# âœ… ãƒ©ãƒ³ã‚¯æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ¬¡å›å®Ÿè¡Œ: æ˜æ—¥ 09:00 JST" >> $GITHUB_STEP_SUMMARY