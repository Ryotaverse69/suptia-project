name: Update Missing Ingredient Amounts

on:
  # æ¯é€±æ—¥æ›œæ—¥ åˆå‰3æ™‚ï¼ˆJST = UTC+9, ã¤ã¾ã‚ŠUTC 18:00åœŸæ›œæ—¥ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: "0 18 * * 6" # æ¯é€±åœŸæ›œæ—¥ 18:00 UTC = æ—¥æ›œæ—¥ 3:00 JST

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (preview only, no updates)"
        required: false
        type: boolean
        default: false

jobs:
  update-ingredients:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ingredient amount update script
        id: update
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          SANITY_API_VERSION: "2025-01-01"
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ğŸ” Dry run mode - preview only"
            node scripts/update-missing-ingredient-amounts.mjs 2>&1 | tee output.log
          else
            echo "âœ… Update mode - applying changes"
            node scripts/update-missing-ingredient-amounts.mjs --fix 2>&1 | tee output.log
          fi

      - name: Extract summary
        id: summary
        run: |
          # ãƒ­ã‚°ã‹ã‚‰é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡º
          TOTAL=$(grep -oP 'å¯¾è±¡å•†å“: \K\d+' output.log || echo "0")
          UPDATED=$(grep -oP 'æ›´æ–°ã—ãŸå•†å“: \K\d+' output.log || echo "0")
          FAILED=$(grep -oP 'æ›´æ–°å¤±æ•—: \K\d+' output.log || echo "0")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Create job summary
        run: |
          echo "## ğŸ“Š æˆåˆ†é‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å¯¾è±¡å•†å“ | ${{ steps.summary.outputs.total }}ä»¶ |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æˆåŠŸ | ${{ steps.summary.outputs.updated }}ä»¶ |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°å¤±æ•— | ${{ steps.summary.outputs.failed }}ä»¶ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "### ğŸ” Dry Run ãƒ¢ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
            echo "å®Ÿéš›ã®æ›´æ–°ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… æ›´æ–°å®Œäº†" >> $GITHUB_STEP_SUMMARY
            echo "Sanityãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Upload log file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingredient-update-log-${{ github.run_number }}
          path: output.log
          retention-days: 30

      # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: Slacké€šçŸ¥ï¼ˆSlack Webhook URLã‚’è¨­å®šã—ãŸå ´åˆã®ã¿ï¼‰
      - name: Notify Slack on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âš ï¸ æˆåˆ†é‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æˆåˆ†é‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¸ãƒ§ãƒ–å¤±æ•—*\n\nå®Ÿè¡Œæ™‚åˆ»: ${{ github.event.head_commit.timestamp }}\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ã‚’è¦‹ã‚‹>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
