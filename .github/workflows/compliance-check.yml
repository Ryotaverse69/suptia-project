name: Compliance Check

on:
  # é€±æ¬¡ã§å®šæœŸå®Ÿè¡Œï¼ˆæ¯é€±æœˆæ›œ 9:00 JSTï¼‰
  schedule:
    - cron: '0 0 * * 1'
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      fix_violations:
        description: 'é•åã‚’è‡ªå‹•ä¿®æ­£ã™ã‚‹'
        required: false
        type: boolean
        default: false
  # PRã§ã®æˆåˆ†/å•†å“å¤‰æ›´æ™‚
  pull_request:
    paths:
      - 'apps/web/src/lib/compliance/**'
      - 'packages/schemas/**'

env:
  NODE_VERSION: '20'

jobs:
  compliance-check:
    name: 6æ³•ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run Compliance Check
        id: compliance
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          # .env.localã‚’ä½œæˆ
          mkdir -p apps/web
          echo "NEXT_PUBLIC_SANITY_PROJECT_ID=$NEXT_PUBLIC_SANITY_PROJECT_ID" > apps/web/.env.local
          echo "NEXT_PUBLIC_SANITY_DATASET=$NEXT_PUBLIC_SANITY_DATASET" >> apps/web/.env.local
          echo "SANITY_API_TOKEN=$SANITY_API_TOKEN" >> apps/web/.env.local
          
          # ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          node scripts/check-compliance-all-content.mjs --report || echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Auto-fix violations (if requested)
        if: github.event.inputs.fix_violations == 'true'
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "ğŸ”§ è‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œä¸­..."
          node scripts/fix-compliance-violations.mjs

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.json
          retention-days: 30

      - name: Create issue on critical violations
        if: contains(steps.compliance.outputs.exit_code, '2')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('compliance-report.json', 'utf8'));
            } catch (e) {
              console.log('ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—');
              return;
            }
            
            const summary = report.summary || {};
            const critical = summary.bySeverity?.critical || 0;
            const high = summary.bySeverity?.high || 0;
            
            if (critical > 0 || high >= 3) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš ï¸ ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
                body: `## æ¤œå‡ºçµæœ
            
            - ğŸ”´ é‡å¤§é•å: ${critical}ä»¶
            - ğŸŸ  é«˜ãƒªã‚¹ã‚¯: ${high}ä»¶
            - ç·é•åæ•°: ${summary.totalViolations || 0}ä»¶
            
            ### æ³•ä»¤åˆ¥
            ${Object.entries(summary.byLaw || {}).map(([law, count]) => `- ${law}: ${count}ä»¶`).join('\n')}
            
            ### å¯¾å¿œ
            1. \`node scripts/check-compliance-all-content.mjs\` ã§è©³ç´°ã‚’ç¢ºèª
            2. \`node scripts/fix-compliance-violations.mjs\` ã§è‡ªå‹•ä¿®æ­£
            3. ä¿®æ­£å¾Œã€å†åº¦ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            
            è©³ç´°ã¯ [compliance-report.json](../actions/runs/${{ github.run_id }}) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
            `,
                labels: ['compliance', 'urgent']
              });
            }

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('compliance-report.json', 'utf8'));
            } catch (e) {
              console.log('ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãªã—');
              return;
            }
            
            const summary = report.summary || {};
            const total = summary.totalViolations || 0;
            const critical = summary.bySeverity?.critical || 0;
            
            let status = 'âœ… åˆæ ¼';
            if (critical > 0) {
              status = 'â›” é‡å¤§é•åã‚ã‚Š';
            } else if (total > 0) {
              status = 'âš ï¸ è»½å¾®ãªé•åã‚ã‚Š';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ“œ 6æ³•ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ
            
            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${status}
            
            | é‡å¤§åº¦ | ä»¶æ•° |
            |--------|------|
            | ğŸ”´ Critical | ${summary.bySeverity?.critical || 0} |
            | ğŸŸ  High | ${summary.bySeverity?.high || 0} |
            | ğŸŸ¡ Medium | ${summary.bySeverity?.medium || 0} |
            | ğŸŸ¢ Low | ${summary.bySeverity?.low || 0} |
            
            ${critical > 0 ? 'âš ï¸ **é‡å¤§ãªé•åãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒ¼ã‚¸å‰ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚**' : ''}
            `
            });

  # ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚«ãƒ¼ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  compliance-unit-tests:
    name: ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci --ignore-scripts

      - name: Run compliance tests
        working-directory: apps/web
        run: npx vitest run src/lib/compliance
