# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å°‚ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
name: "Security Checks"

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 18 * * *'  # UTCæ™‚é–“ã§18:00 = JSTç¿Œæ—¥03:00

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install security scanning tools
        run: |
          npm install -g @secretlint/cli @secretlint/secretlint-rule-preset-recommend
          npm install -g gitleaks

      - name: Run Secretlint
        run: |
          # Secretlintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > .secretlintrc.json << 'EOF'
          {
            "rules": [
              {
                "id": "@secretlint/secretlint-rule-preset-recommend"
              }
            ]
          }
          EOF
          
          # Secretlintã‚’å®Ÿè¡Œ
          secretlint "**/*" --format json --output secretlint-results.json || true
          
          # çµæœã‚’ç¢ºèª
          if [ -f "secretlint-results.json" ]; then
            SECRETS_COUNT=$(jq '.length' secretlint-results.json 2>/dev/null || echo "0")
            echo "Potential secrets found: $SECRETS_COUNT"
            
            if [ "$SECRETS_COUNT" -gt "0" ]; then
              echo "::error::Potential secrets detected in repository"
              jq -r '.[] | "File: \(.filePath), Line: \(.range.start.line), Rule: \(.ruleId)"' secretlint-results.json
              exit 1
            fi
          fi

      - name: Check for tracked environment files
        run: |
          # .envãƒ•ã‚¡ã‚¤ãƒ«ãŒGitã§è¿½è·¡ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          TRACKED_ENV_FILES=$(git ls-files | grep -E '(^|/)\.env(\.|$)' || true)
          if [ -n "$TRACKED_ENV_FILES" ]; then
            echo "::error::Environment files are being tracked in Git:"
            echo "$TRACKED_ENV_FILES"
            exit 1
          fi
          echo "âœ… No environment files are tracked in Git"

      - name: Verify .gitignore patterns
        run: |
          # .gitignoreã«å¿…è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          REQUIRED_PATTERNS=(".env" ".env.local" "*.log" "node_modules/")
          MISSING_PATTERNS=()
          
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "^$pattern" .gitignore; then
              MISSING_PATTERNS+=("$pattern")
            fi
          done
          
          if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
            echo "::warning::Missing .gitignore patterns:"
            printf '%s\n' "${MISSING_PATTERNS[@]}"
          else
            echo "âœ… All required .gitignore patterns are present"
          fi

      - name: Upload secret scanning results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scanning-results
          path: |
            secretlint-results.json
          retention-days: 30

  dependency-security:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: |
          npm ci
          cd apps/web && npm ci

      - name: Run npm audit
        run: |
          echo "# ğŸ” ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ" > audit-report.md
          echo "" >> audit-report.md
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> audit-report.md
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: \`${{ github.sha }}\`" >> audit-report.md
          echo "" >> audit-report.md
          
          # ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®ç›£æŸ»
          echo "## ãƒ«ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" >> audit-report.md
          npm audit --json > root-audit.json 2>/dev/null || true
          
          if [ -f "root-audit.json" ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' root-audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' root-audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' root-audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' root-audit.json)
            
            echo "- ğŸ”´ Critical: $CRITICAL" >> audit-report.md
            echo "- ğŸŸ¡ High: $HIGH" >> audit-report.md
            echo "- ğŸŸ  Moderate: $MODERATE" >> audit-report.md
            echo "- ğŸ”µ Low: $LOW" >> audit-report.md
            echo "" >> audit-report.md
            
            if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
              echo "::error::Critical or High severity vulnerabilities found in root dependencies"
              AUDIT_FAILED=true
            fi
          fi
          
          # Webã‚¢ãƒ—ãƒªã®ç›£æŸ»
          echo "## Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³" >> audit-report.md
          cd apps/web
          npm audit --json > web-audit.json 2>/dev/null || true
          
          if [ -f "web-audit.json" ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' web-audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' web-audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' web-audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' web-audit.json)
            
            echo "- ğŸ”´ Critical: $CRITICAL" >> ../audit-report.md
            echo "- ğŸŸ¡ High: $HIGH" >> ../audit-report.md
            echo "- ğŸŸ  Moderate: $MODERATE" >> ../audit-report.md
            echo "- ğŸ”µ Low: $LOW" >> ../audit-report.md
            echo "" >> ../audit-report.md
            
            if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
              echo "::error::Critical or High severity vulnerabilities found in web app dependencies"
              AUDIT_FAILED=true
            fi
          fi
          
          cd ..
          
          # ç›£æŸ»çµæœã®ã‚µãƒãƒªãƒ¼
          if [ "$AUDIT_FAILED" = "true" ]; then
            echo "## âš ï¸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¿…è¦" >> audit-report.md
            echo "Critical ã¾ãŸã¯ High ãƒ¬ãƒ™ãƒ«ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚" >> audit-report.md
            echo "ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚" >> audit-report.md
            exit 1
          else
            echo "## âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹è‰¯å¥½" >> audit-report.md
            echo "é‡å¤§ãªè„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> audit-report.md
          fi

      - name: Check for outdated packages
        run: |
          echo "" >> audit-report.md
          echo "## ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°çŠ¶æ³" >> audit-report.md
          echo "" >> audit-report.md
          
          # å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          npm outdated --format json > outdated.json 2>/dev/null || echo "[]" > outdated.json
          
          OUTDATED_COUNT=$(jq 'length' outdated.json)
          echo "æ›´æ–°å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•°: $OUTDATED_COUNT" >> audit-report.md
          
          if [ "$OUTDATED_COUNT" -gt "0" ]; then
            echo "" >> audit-report.md
            echo "### æ›´æ–°æ¨å¥¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸" >> audit-report.md
            jq -r '.[] | "- \(.name): \(.current) â†’ \(.latest)"' outdated.json >> audit-report.md
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-results
          path: |
            audit-report.md
            root-audit.json
            apps/web/web-audit.json
            outdated.json
          retention-days: 30

      - name: Comment audit results on PR
        if: github.event_name == 'pull_request' && always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "audit-report.md" ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file audit-report.md
          fi

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: |
          npm ci
          cd apps/web && npm ci

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          echo "# ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ ãƒ¬ãƒãƒ¼ãƒˆ" > license-report.md
          echo "" >> license-report.md
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> license-report.md
          echo "" >> license-report.md
          
          # è¨±å¯ã•ã‚ŒãŸãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ãƒªã‚¹ãƒˆ
          ALLOWED_LICENSES="MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense;CC0-1.0"
          
          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          license-checker --onlyAllow "$ALLOWED_LICENSES" --json > licenses.json 2>/dev/null || true
          
          if [ $? -eq 0 ]; then
            echo "âœ… **ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒè¨±å¯ã•ã‚ŒãŸãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™**" >> license-report.md
            
            # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹çµ±è¨ˆ
            echo "" >> license-report.md
            echo "## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹çµ±è¨ˆ" >> license-report.md
            jq -r 'to_entries | group_by(.value.licenses) | .[] | "\(.length) packages: \(.[0].value.licenses)"' licenses.json | sort -nr >> license-report.md
          else
            echo "âš ï¸ **è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**" >> license-report.md
            echo "::warning::Unauthorized licenses detected"
          fi

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-compliance-report
          path: |
            license-report.md
            licenses.json
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-security, license-compliance]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all security results
        uses: actions/download-artifact@v4
        with:
          pattern: "*-results"
          merge-multiple: true

      - name: Generate comprehensive security report
        run: |
          echo "# ğŸ›¡ï¸ åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ" > security-report.md
          echo "" >> security-report.md
          echo "**ç”Ÿæˆæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: \`${{ github.sha }}\`" >> security-report.md
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`" >> security-report.md
          echo "" >> security-report.md
          
          # ã‚¸ãƒ§ãƒ–çµæœã®ç¢ºèª
          SECRET_STATUS="${{ needs.secret-scanning.result }}"
          DEPENDENCY_STATUS="${{ needs.dependency-security.result }}"
          LICENSE_STATUS="${{ needs.license-compliance.result }}"
          
          echo "## ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯çµæœ" >> security-report.md
          echo "" >> security-report.md
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
          case "$SECRET_STATUS" in
            "success") SECRET_ICON="âœ…" ;;
            "failure") SECRET_ICON="âŒ" ;;
            *) SECRET_ICON="âš ï¸" ;;
          esac
          
          case "$DEPENDENCY_STATUS" in
            "success") DEPENDENCY_ICON="âœ…" ;;
            "failure") DEPENDENCY_ICON="âŒ" ;;
            *) DEPENDENCY_ICON="âš ï¸" ;;
          esac
          
          case "$LICENSE_STATUS" in
            "success") LICENSE_ICON="âœ…" ;;
            "failure") LICENSE_ICON="âŒ" ;;
            *) LICENSE_ICON="âš ï¸" ;;
          esac
          
          echo "| ãƒã‚§ãƒƒã‚¯é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | çµæœ |" >> security-report.md
          echo "|-------------|-----------|------|" >> security-report.md
          echo "| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³ | $SECRET_ICON | $SECRET_STATUS |" >> security-report.md
          echo "| ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | $DEPENDENCY_ICON | $DEPENDENCY_STATUS |" >> security-report.md
          echo "| ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ | $LICENSE_ICON | $LICENSE_STATUS |" >> security-report.md
          echo "" >> security-report.md
          
          # ç·åˆè©•ä¾¡
          if [ "$SECRET_STATUS" = "success" ] && [ "$DEPENDENCY_STATUS" = "success" ] && [ "$LICENSE_STATUS" = "success" ]; then
            echo "## ğŸ‰ ç·åˆè©•ä¾¡: è‰¯å¥½" >> security-report.md
            echo "ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚" >> security-report.md
          else
            echo "## âš ï¸ ç·åˆè©•ä¾¡: è¦æ³¨æ„" >> security-report.md
            echo "ä¸€éƒ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> security-report.md
          echo "" >> security-report.md
          echo "1. å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’ç¢ºèª" >> security-report.md
          echo "2. æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã®ä¿®æ­£" >> security-report.md
          echo "3. ä¾å­˜é–¢ä¿‚ã®å®šæœŸçš„ãªæ›´æ–°" >> security-report.md
          echo "4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®éµå®ˆ" >> security-report.md

      - name: Upload comprehensive security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report
          path: security-report.md
          retention-days: 90

      - name: Create security issue on failure
        if: failure() && github.ref == 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å¤±æ•— - $(date '+%Y-%m-%d')"
          ISSUE_BODY="$(cat <<EOF
**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**

**è©³ç´°:**
- ã‚³ãƒŸãƒƒãƒˆ: \`${{ github.sha }}\`
- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
- å®Ÿè¡Œæ—¥æ™‚: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

**ãƒã‚§ãƒƒã‚¯çµæœ:**
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.secret-scanning.result }}
- ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ needs.dependency-security.result }}
- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹: ${{ needs.license-compliance.result }}

**å¯¾å¿œãŒå¿…è¦ãªé …ç›®:**
$(if [ "${{ needs.secret-scanning.result }}" != "success" ]; then echo "- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³ã®å•é¡Œã‚’ç¢ºèª"; fi)
$(if [ "${{ needs.dependency-security.result }}" != "success" ]; then echo "- ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ä¿®æ­£"; fi)
$(if [ "${{ needs.license-compliance.result }}" != "success" ]; then echo "- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å•é¡Œã‚’è§£æ±º"; fi)

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
2. æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£
3. ä¿®æ­£å¾Œã«å†åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
4. å•é¡ŒãŒè§£æ±ºã•ã‚ŒãŸã‚‰ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
EOF
)"
          
          gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "security,urgent,bug" \
            --assignee "${{ github.actor }}"