name: Deploy with Skills Check

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  pre-deploy-checks:
    name: Pre-deployment Skills Check
    runs-on: ubuntu-latest
    outputs:
      deploy_ready: ${{ steps.checks.outputs.ready }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd .claude/skills && npm ci

      - name: Setup environment
        run: |
          echo "NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.SANITY_PROJECT_ID }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SANITY_DATASET=${{ secrets.SANITY_DATASET }}" >> $GITHUB_ENV
          echo "SANITY_API_TOKEN=${{ secrets.SANITY_API_TOKEN }}" >> $GITHUB_ENV

      - name: Run article validation
        id: validate
        run: |
          echo "### ðŸ“ è¨˜äº‹æ¤œè¨¼" >> $GITHUB_STEP_SUMMARY
          if npm run skill:validate --batch "*-article.json"; then
            echo "âœ… è¨˜äº‹æ¤œè¨¼: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "validate_pass=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ è¨˜äº‹æ¤œè¨¼: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "validate_pass=false" >> $GITHUB_OUTPUT
          fi

      - name: Run compliance check
        id: compliance
        run: |
          echo "### âš–ï¸ è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          if npm run skill:compliance check --all; then
            echo "âœ… è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
            echo "compliance_pass=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
            echo "compliance_pass=false" >> $GITHUB_OUTPUT
          fi

      - name: Run deploy readiness check
        id: deploy_check
        run: |
          echo "### ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          if npm run skill:dev deploy:check; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™: å®Œäº†" >> $GITHUB_STEP_SUMMARY
            echo "deploy_ready=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™: æœªå®Œäº†" >> $GITHUB_STEP_SUMMARY
            echo "deploy_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Overall check status
        id: checks
        run: |
          if [[ "${{ steps.validate.outputs.validate_pass }}" == "true" ]] && \
             [[ "${{ steps.compliance.outputs.compliance_pass }}" == "true" ]] && \
             [[ "${{ steps.deploy_check.outputs.deploy_ready }}" == "true" ]]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "## âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "## âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-deploy-reports
          path: |
            .claude/skills/logs/
            .pipeline-output/

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.deploy_ready == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.SANITY_DATASET }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: apps/web/.next

  optimize-content:
    name: Optimize Content
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.deploy_ready == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd .claude/skills && npm ci

      - name: Run article optimization pipeline
        run: |
          echo "### ðŸ“ˆ è¨˜äº‹æœ€é©åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³" >> $GITHUB_STEP_SUMMARY
          npm run skill:pipeline article-complete --save
          echo "âœ… è¨˜äº‹æœ€é©åŒ–å®Œäº†" >> $GITHUB_STEP_SUMMARY

      - name: Commit optimized articles
        uses: EndBug/add-and-commit@v9
        with:
          message: 'ðŸ“ Auto-optimize articles before deployment'
          add: '*-article.json'
        if: github.event_name == 'push'

  sync-sanity:
    name: Sync with Sanity
    runs-on: ubuntu-latest
    needs: [build-and-test, optimize-content]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd .claude/skills && npm ci

      - name: Setup environment
        run: |
          echo "SANITY_API_TOKEN=${{ secrets.SANITY_API_TOKEN }}" >> $GITHUB_ENV

      - name: Sync data with Sanity
        run: |
          echo "### ðŸ”„ Sanityãƒ‡ãƒ¼ã‚¿åŒæœŸ" >> $GITHUB_STEP_SUMMARY
          npm run skill:dev sanity:sync
          echo "âœ… SanityåŒæœŸå®Œäº†" >> $GITHUB_STEP_SUMMARY

  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build-and-test, sync-sanity]
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_TEAM_ID }}

      - name: Update deployment summary
        run: |
          echo "### ðŸŽ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY

  post-deploy-validation:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-vercel

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd .claude/skills && npm ci

      - name: Run E2E tests on production
        run: |
          echo "### ðŸ§ª æœ¬ç•ªç’°å¢ƒE2Eãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
          npm run test:e2e -- --url ${{ needs.deploy-vercel.outputs.url }}
          echo "âœ… E2Eãƒ†ã‚¹ãƒˆåˆæ ¼" >> $GITHUB_STEP_SUMMARY

      - name: Run Lighthouse audit
        run: |
          echo "### ðŸš¦ Lighthouseãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£æŸ»" >> $GITHUB_STEP_SUMMARY
          npx @lhci/cli autorun --collect.url=${{ needs.deploy-vercel.outputs.url }}
          echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£æŸ»å®Œäº†" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-validation]
    if: always()

    steps:
      - name: Create deployment summary
        run: |
          echo "# ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**æ—¥æ™‚**: $(date)" >> deployment-report.md
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}" >> deployment-report.md
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" >> deployment-report.md
          echo "- Pre-deploy checks: âœ…" >> deployment-report.md
          echo "- Build: âœ…" >> deployment-report.md
          echo "- Content optimization: âœ…" >> deployment-report.md
          echo "- Sanity sync: âœ…" >> deployment-report.md
          echo "- Vercel deployment: âœ…" >> deployment-report.md
          echo "- Post-deploy validation: âœ…" >> deployment-report.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ Deployment Complete!
            Environment: Production
            URL: ${{ needs.deploy-vercel.outputs.url }}
            Status: ${{ needs.post-deploy-validation.result }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}