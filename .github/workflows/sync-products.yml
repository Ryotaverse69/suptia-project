name: EC商品自動同期

on:
  # 毎日深夜3時（JST）に実行 = UTC 18:00
  schedule:
    - cron: '0 18 * * *'

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      source:
        description: 'ECサイト (rakuten, yahoo, all)'
        required: false
        default: 'all'
      keyword:
        description: '検索キーワード'
        required: false
        default: 'サプリメント'
      limit:
        description: '取得件数'
        required: false
        default: '100'

jobs:
  sync-rakuten:
    name: 楽天商品同期
    runs-on: ubuntu-latest
    if: github.event.inputs.source == 'rakuten' || github.event.inputs.source == 'all' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > apps/web/.env.local << EOF
          SANITY_API_TOKEN=${{ secrets.SANITY_API_TOKEN }}
          RAKUTEN_APPLICATION_ID=${{ secrets.RAKUTEN_APPLICATION_ID }}
          RAKUTEN_AFFILIATE_ID=${{ secrets.RAKUTEN_AFFILIATE_ID }}
          EOF

      - name: Sync Rakuten products
        run: |
          KEYWORD="${{ github.event.inputs.keyword || 'サプリメント' }}"
          LIMIT="${{ github.event.inputs.limit || '100' }}"
          node scripts/sync-rakuten-products.mjs "$KEYWORD" --limit $LIMIT

  sync-yahoo:
    name: Yahoo!商品同期
    runs-on: ubuntu-latest
    if: github.event.inputs.source == 'yahoo' || github.event.inputs.source == 'all' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > apps/web/.env.local << EOF
          SANITY_API_TOKEN=${{ secrets.SANITY_API_TOKEN }}
          YAHOO_SHOPPING_CLIENT_ID=${{ secrets.YAHOO_SHOPPING_CLIENT_ID }}
          YAHOO_AFFILIATE_ID=${{ secrets.YAHOO_AFFILIATE_ID }}
          EOF

      - name: Sync Yahoo products
        run: |
          KEYWORD="${{ github.event.inputs.keyword || 'サプリメント' }}"
          LIMIT="${{ github.event.inputs.limit || '100' }}"
          node scripts/sync-yahoo-products.mjs "$KEYWORD" --limit $LIMIT

  calculate-ranks:
    name: ランク・バッジ計算
    runs-on: ubuntu-latest
    needs: [sync-rakuten, sync-yahoo]
    if: needs.sync-rakuten.result == 'success' || needs.sync-yahoo.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > apps/web/.env.local << EOF
          SANITY_API_TOKEN=${{ secrets.SANITY_API_TOKEN }}
          NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET=${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_VERSION=2024-01-01
          EOF

      - name: Post-sync validation (成分リンク・ゼロ含有量修正)
        run: node scripts/post-sync-validation.mjs --fix --quick

      - name: Calculate tier ranks
        run: node scripts/auto-calculate-tier-ranks.mjs --fix

      - name: Calculate badges
        run: node scripts/calculate-badges.mjs --fix

      - name: Revalidate frontend (ISR)
        run: |
          curl -X POST "https://suptia.com/api/revalidate" \
            -H "Content-Type: application/json" \
            -H "x-revalidate-secret: ${{ secrets.REVALIDATE_SECRET }}" \
            -d '{"path": "/products"}'

  notify:
    name: 同期完了通知
    runs-on: ubuntu-latest
    needs: [sync-rakuten, sync-yahoo, calculate-ranks]
    if: always()

    steps:
      - name: Check sync results
        run: |
          echo "楽天同期: ${{ needs.sync-rakuten.result }}"
          echo "Yahoo同期: ${{ needs.sync-yahoo.result }}"
          echo "ランク・バッジ計算: ${{ needs.calculate-ranks.result }}"

          if [ "${{ needs.sync-rakuten.result }}" != "success" ] && [ "${{ needs.sync-yahoo.result }}" != "success" ]; then
            echo "⚠️  価格同期が失敗しました"
            exit 1
          elif [ "${{ needs.calculate-ranks.result }}" != "success" ]; then
            echo "⚠️  ランク・バッジ計算が失敗しました（価格は更新済み）"
            exit 1
          else
            echo "✅ すべての同期が成功しました"
            echo "   - 価格データ更新: ✓"
            echo "   - Tierランク計算: ✓"
            echo "   - 称号バッジ計算: ✓"
            echo "   - フロントエンド更新: ✓"
          fi
