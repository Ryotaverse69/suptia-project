name: Data Quality Check

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JST (0:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-data-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create reports directory
        run: mkdir -p reports

      # 1. æˆåˆ†é‡ãƒã‚§ãƒƒã‚¯
      - name: Check ingredient amounts
        id: amount_check
        continue-on-error: true
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          node scripts/check-ingredient-amounts.mjs > reports/amount-check.txt 2>&1
          cat reports/amount-check.txt

          # 0mgå•é¡ŒãŒã‚ã‚Œã°è­¦å‘Š
          if grep -q "0mgï¼ˆãƒ‡ãƒ¼ã‚¿æœªå…¥åŠ›ï¼‰: [1-9]" reports/amount-check.txt; then
            echo "has_amount_issues=true" >> $GITHUB_OUTPUT
          fi

      # 2. æˆåˆ†ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
      - name: Validate ingredient quality
        id: quality_check
        continue-on-error: true
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          node scripts/validate-ingredient-quality.mjs --json > reports/quality-check.txt 2>&1 || true
          cat reports/quality-check.txt

          # å“è³ªã‚¹ã‚³ã‚¢ãŒ80æœªæº€ãªã‚‰è­¦å‘Š
          if grep -q "å“è³ªã‚¹ã‚³ã‚¢: [0-7][0-9]/" reports/quality-check.txt; then
            echo "has_quality_issues=true" >> $GITHUB_OUTPUT
          fi

      # 3. Tierãƒ©ãƒ³ã‚¯ã®ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
      - name: Check tier rank consistency
        id: tier_check
        continue-on-error: true
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          node scripts/check-product-scores.mjs > reports/tier-check.txt 2>&1
          cat reports/tier-check.txt

          # Tierãƒ©ãƒ³ã‚¯æœªè¨­å®šãŒ5ä»¶ä»¥ä¸Šã‚ã‚Œã°è­¦å‘Š
          if grep -q "Tierãƒ©ãƒ³ã‚¯æœªè¨­å®š: [5-9]\|Tierãƒ©ãƒ³ã‚¯æœªè¨­å®š: [1-9][0-9]" reports/tier-check.txt; then
            echo "has_tier_issues=true" >> $GITHUB_OUTPUT
          fi

      # 4. ä¾¡æ ¼ãƒ»ã‚³ã‚¹ãƒ‘è¨ˆç®—ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      - name: Check price and cost-effectiveness
        id: price_check
        continue-on-error: true
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          node scripts/check-price-costperformance.mjs > reports/price-check.txt 2>&1
          cat reports/price-check.txt

          # æˆåˆ†ãƒ‡ãƒ¼ã‚¿ãªã—ãŒ5ä»¶ä»¥ä¸Šã‚ã‚Œã°è­¦å‘Š
          if grep -q "æˆåˆ†ãƒ‡ãƒ¼ã‚¿ãªã—: [5-9]\|æˆåˆ†ãƒ‡ãƒ¼ã‚¿ãªã—: [1-9][0-9]" reports/price-check.txt; then
            echo "has_price_issues=true" >> $GITHUB_OUTPUT
          fi

      # 5. æˆåˆ†é‡ã®ç•°å¸¸å€¤ãƒã‚§ãƒƒã‚¯ãƒ»è‡ªå‹•ä¿®æ­£
      - name: Validate and fix ingredient amounts
        id: ingredient_validation
        continue-on-error: true
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "ğŸ” æˆåˆ†é‡ã®ç•°å¸¸å€¤ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          node scripts/validate-and-fix-ingredient-amounts.mjs --fix > reports/ingredient-validation.txt 2>&1
          cat reports/ingredient-validation.txt

          # ä¿®æ­£ãŒè¡Œã‚ã‚ŒãŸå ´åˆ
          if grep -q "ä¿®æ­£å®Œäº†: [1-9]" reports/ingredient-validation.txt; then
            echo "ingredients_fixed=true" >> $GITHUB_OUTPUT

      # 5.5. RDAãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
      - name: Check RDA coverage
        id: rda_check
        continue-on-error: true
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "ğŸ” RDAãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          node scripts/rda-coverage-check.mjs > reports/rda-coverage.txt 2>&1
          cat reports/rda-coverage.txt

          # æœªç™»éŒ²æˆåˆ†ãŒã‚ã‚Œã°è­¦å‘Š
          if grep -q "RDAãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æœªç™»éŒ²ã®æˆåˆ†:" reports/rda-coverage.txt; then
            echo "has_rda_issues=true" >> $GITHUB_OUTPUT
          fi

      # 6. å•é¡ŒãŒã‚ã‚Œã°Issueä½œæˆ
      - name: Create Issue if problems found
        if: steps.amount_check.outputs.has_amount_issues == 'true' || steps.quality_check.outputs.has_quality_issues == 'true' || steps.tier_check.outputs.has_tier_issues == 'true' || steps.price_check.outputs.has_price_issues == 'true' || steps.rda_check.outputs.has_rda_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = '## ğŸ“Š é€±æ¬¡ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯çµæœ\n\n';
            body += `å®Ÿè¡Œæ—¥æ™‚: ${new Date().toISOString()}\n\n`;

            // æˆåˆ†é‡ãƒã‚§ãƒƒã‚¯çµæœ
            if (fs.existsSync('reports/amount-check.txt')) {
              const amountResult = fs.readFileSync('reports/amount-check.txt', 'utf8');
              body += '### 1. æˆåˆ†é‡ãƒã‚§ãƒƒã‚¯\n\n';
              body += '```\n' + amountResult.substring(0, 10000) + '\n```\n\n';
            }

            // å“è³ªãƒã‚§ãƒƒã‚¯çµæœ
            if (fs.existsSync('reports/quality-check.txt')) {
              const qualityResult = fs.readFileSync('reports/quality-check.txt', 'utf8');
              body += '### 2. æˆåˆ†ãƒ‡ãƒ¼ã‚¿å“è³ª\n\n';
              body += '```\n' + qualityResult.substring(0, 10000) + '\n```\n\n';
            }

            // Tierãƒ©ãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯çµæœ
            if (fs.existsSync('reports/tier-check.txt')) {
              const tierResult = fs.readFileSync('reports/tier-check.txt', 'utf8');
              body += '### 3. Tierãƒ©ãƒ³ã‚¯ä¸€è²«æ€§\n\n';
              body += '```\n' + tierResult.substring(0, 10000) + '\n```\n\n';
            }

            // ä¾¡æ ¼ãƒ»ã‚³ã‚¹ãƒ‘ãƒã‚§ãƒƒã‚¯çµæœ
            if (fs.existsSync('reports/price-check.txt')) {
              const priceResult = fs.readFileSync('reports/price-check.txt', 'utf8');
              body += '### 4. ä¾¡æ ¼ãƒ»ã‚³ã‚¹ãƒ‘è¨ˆç®—\n\n';
              body += '```\n' + priceResult.substring(0, 10000) + '\n```\n\n';
            }

            // æˆåˆ†é‡æ¤œè¨¼çµæœ
            if (fs.existsSync('reports/ingredient-validation.txt')) {
              const validationResult = fs.readFileSync('reports/ingredient-validation.txt', 'utf8');
              body += '### 5. æˆåˆ†é‡ç•°å¸¸å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå‹•ä¿®æ­£æ¸ˆã¿ï¼‰\n\n';
              body += '```\n' + validationResult.substring(0, 10000) + '\n```\n\n';
            }

            // RDAã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯çµæœ
            if (fs.existsSync('reports/rda-coverage.txt')) {
              const rdaResult = fs.readFileSync('reports/rda-coverage.txt', 'utf8');
              body += '### 6. RDAãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚«ãƒãƒ¬ãƒƒã‚¸\n\n';
              body += '```\n' + rdaResult.substring(0, 10000) + '\n```\n\n';
            }

            body += '---\n';
            body += '### ğŸ”§ è‡ªå‹•ä¿®æ­£æ¸ˆã¿\n\n';
            body += '- âœ… æˆåˆ†é‡ã®ç•°å¸¸å€¤\n';
            body += '- âœ… Tierãƒ©ãƒ³ã‚¯æœªè¨­å®š\n\n';
            body += '### ğŸ“‹ æ‰‹å‹•å¯¾å¿œãŒå¿…è¦\n\n';
            body += '1. æˆåˆ†ãƒ‡ãƒ¼ã‚¿ãªã—: Sanityã§æˆåˆ†ã‚’æ‰‹å‹•è¿½åŠ \n';
            body += '2. ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ©ãƒ³ã‚¯ä¸ä¸€è‡´: `node scripts/fix-ingredient-ranks.mjs`\n';
            body += '3. RDAæœªç™»éŒ²æˆåˆ†: `ingredient-aliases.json` ã¾ãŸã¯ `rda-standards.json` ã«è¿½åŠ \n';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ é€±æ¬¡ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
              body: body.substring(0, 65000),
              labels: ['data-quality', 'automated']
            });

      # 7. Tierãƒ©ãƒ³ã‚¯å•é¡ŒãŒã‚ã‚Œã°è‡ªå‹•ä¿®æ­£
      - name: Auto-fix tier ranks if issues found
        if: steps.tier_check.outputs.has_tier_issues == 'true'
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
        run: |
          echo "ğŸ”§ Tierãƒ©ãƒ³ã‚¯ã®è‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œä¸­..."
          node scripts/auto-calculate-tier-ranks.mjs --fix
          echo "âœ… Tierãƒ©ãƒ³ã‚¯ä¿®æ­£å®Œäº†"

      # 8. ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: data-quality-reports
          path: reports/
          retention-days: 30
